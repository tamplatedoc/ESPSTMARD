   <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="storyPageTitle">Loading Story...</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> <style>
        /* Anda bisa menyalin CSS dari halaman katalog atau mendefinisikan yang baru */
        /* Contoh CSS untuk halaman detail cerita */
        :root {
            --background-start: #0a0a0f;
            --background-end: #1a1a2e;
            --container-background: #1f2038;
            --input-background: #282a46;
            --text-color: #e0e0e0;
            --accent-color: #8c7ae6;
            --gradient-1-start: #8c7ae6;
            --gradient-1-end: #6c5ce7;
            --border-color: #3f425b;
            --light-mode-background-start: #e0e0e0;
            --light-mode-background-end: #f0f0f0;
            --light-mode-container-background: #ffffff;
            --light-mode-input-background: #f8f8f8;
            --light-mode-text-color: #333333;
            --star-filled: #FFD700; /* Gold */
            --star-empty: #ccc;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--background-start), var(--background-end));
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background 0.3s ease, color 0.3s ease;
        }

        body.light-mode {
            background: linear-gradient(135deg, var(--light-mode-background-start), var(--light-mode-background-end));
            color: var(--light-mode-text-color);
        }

        header {
            background-color: rgba(31, 32, 56, 0.8);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        header .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8em;
            color: var(--accent-color);
            text-decoration: none;
            text-shadow: 0 0 8px rgba(140, 122, 230, 0.6);
        }
        body.light-mode header .logo {
            color: var(--light-mode-text-color);
            text-shadow: none;
        }


        main {
            flex-grow: 1;
            padding: 20px;
            max-width: 900px;
            margin: 20px auto;
            background-color: var(--container-background);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border-color);
        }

        body.light-mode main {
            background-color: var(--light-mode-container-background);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .story-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .story-header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5em;
            color: var(--accent-color);
            text-shadow: 0 0 10px rgba(140, 122, 230, 0.6);
            margin-bottom: 10px;
        }
        body.light-mode .story-header h1 {
            color: var(--light-mode-text-color);
            text-shadow: none;
        }


        .story-header p {
            font-size: 1.1em;
            color: #ccc;
        }
        body.light-mode .story-header p {
            color: var(--light-mode-text-color);
        }


        .story-thumbnail {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }
        body.light-mode .story-thumbnail {
            border: 1px solid rgba(0,0,0,0.1);
        }

        .story-content {
            font-size: 1.05em;
            line-height: 1.8;
            margin-bottom: 40px;
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
        }

        .story-stats {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-bottom: 40px;
            font-size: 1.1em;
            color: var(--text-color);
        }

        .story-stats span .icon {
            margin-right: 8px;
            color: var(--accent-color);
        }

        .rating-section, .comments-section {
            padding-top: 30px;
            border-top: 1px solid var(--border-color);
            margin-top: 30px;
        }
        body.light-mode .rating-section, body.light-mode .comments-section {
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .rating-section h2, .comments-section h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8em;
            color: var(--accent-color);
            text-align: center;
            margin-bottom: 25px;
            text-shadow: 0 0 8px rgba(140, 122, 230, 0.3);
        }
        body.light-mode .rating-section h2, body.light-mode .comments-section h2 {
            color: var(--light-mode-text-color);
            text-shadow: none;
        }


        .stars {
            display: flex;
            justify-content: center;
            gap: 5px;
            font-size: 2.5em;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .star {
            color: var(--star-empty);
            transition: color 0.2s ease;
        }

        .star.filled {
            color: var(--star-filled);
        }

        .comment-form textarea {
            width: calc(100% - 20px);
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--input-background);
            color: var(--text-color);
            font-size: 1em;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
            resize: vertical;
            min-height: 100px;
            margin-bottom: 15px;
        }
        body.light-mode .comment-form textarea {
            background-color: var(--light-mode-input-background);
            border: 1px solid rgba(0,0,0,0.1);
            color: var(--light-mode-text-color);
        }


        .comment-form button {
            background: linear-gradient(45deg, var(--gradient-1-start), var(--gradient-1-end));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: block;
            width: 100%;
        }
        .comment-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(140, 122, 230, 0.5);
        }

        .comment-list {
            margin-top: 30px;
        }

        .comment-item {
            background-color: var(--input-background);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        body.light-mode .comment-item {
            background-color: var(--light-mode-input-background);
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }


        .comment-item strong {
            color: var(--accent-color);
            margin-bottom: 5px;
            display: block;
        }
        body.light-mode .comment-item strong {
            color: var(--light-mode-text-color);
        }


        .comment-item p {
            margin: 5px 0;
            font-size: 0.95em;
        }

        .comment-item small {
            display: block;
            text-align: right;
            color: #aaa;
            font-size: 0.8em;
            margin-top: 10px;
        }

        footer {
            background-color: rgba(31, 32, 56, 0.8);
            padding: 20px;
            text-align: center;
            font-size: 0.9em;
            margin-top: 40px;
            backdrop-filter: blur(5px);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
        }

        footer nav a {
            color: var(--text-color);
            text-decoration: none;
            margin: 0 10px;
            transition: color 0.2s ease;
        }

        footer nav a:hover {
            color: var(--accent-color);
        }

        body.light-mode footer {
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        body.light-mode footer nav a {
            color: var(--light-mode-text-color);
        }

        @media (max-width: 768px) {
            main {
                padding: 15px;
                margin: 15px auto;
            }

            .story-header h1 {
                font-size: 2em;
            }

            .stars {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <header>
        <a href="/" class="logo">AMDF EBOOK</a>
        <button id="themeToggle">💡</button>
    </header>

    <main>
        <div class="story-header">
            <h1 id="storyTitle">Loading Story Title...</h1>
            <p>Author: <span id="storyAuthor">Loading...</span> | Genre: <span id="storyGenre">Loading...</span></p>
        </div>

        <img id="storyThumbnail" src="https://via.placeholder.com/800x450/cccccc/000000?text=Loading+Thumbnail" alt="Story Thumbnail" class="story-thumbnail">

        <div class="story-content" id="storyContent">
            <p>Loading story content...</p>
        </div>

        <div class="story-stats">
            <span><span class="icon">👁️</span> Views: <span id="storyViews">0</span></span>
            <span><span class="icon">⭐</span> Rating: <span id="storyRating">0.0</span> (<span id="storyRatingCount">0</span>)</span>
        </div>

        <section class="rating-section">
            <h2>Rate This Story</h2>
            <div class="stars" id="ratingStars">
                <i class="fa-solid fa-star star" data-value="1"></i>
                <i class="fa-solid fa-star star" data-value="2"></i>
                <i class="fa-solid fa-star star" data-value="3"></i>
                <i class="fa-solid fa-star star" data-value="4"></i>
                <i class="fa-solid fa-star star" data-value="5"></i>
            </div>
            <p id="ratingMessage" style="text-align: center; color: #ccc;"></p>
        </section>

        <section class="comments-section">
            <h2>Comments</h2>
            <form id="commentForm" class="comment-form">
                <textarea id="commentContent" placeholder="Write your comment here..." required></textarea>
                <button type="submit">Post Comment</button>
            </form>
            <div id="commentList" class="comment-list">
                <p>No comments yet. Be the first to comment!</p>
                </div>
        </section>
    </main>

    <footer>
        <nav>
            <a href="/about">About Us</a>
            <a href="/privacy-policy">Privacy Policy</a>
            <a href="/terms-of-service">Terms of Service</a>
            <a href="/contact">Contact</a>
        </nav>
        <p>&copy; AMDF.GROUP</p>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script> <script>
        // === KONFIGURASI DAN INISIALISASI FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyDeiLybtGc6evATj5O7M1FiJd1GPYd-rYc",
            authDomain: "tamplatedoc.firebaseapp.com",
            databaseURL: "https://tamplatedoc-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tamplatedoc",
            storageBucket: "tamplatedoc.firebasestorage.app",
            messagingSenderId: "264966107720",
            appId: "1:264966107720:web:da19f6109e71390740de7d",
            measurementId: "G-PFK8VQBFCV"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const rtdb = firebase.database();
        const auth = firebase.auth(); // Untuk mendapatkan user ID saat rating/komentar
    </script>

    <script>
        // === THEME TOGGLE ===
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            body.classList.add(savedTheme);
            themeToggle.textContent = savedTheme === 'light-mode' ? '🌙' : '💡';
        }

        themeToggle.addEventListener('click', () => {
            if (body.classList.contains('light-mode')) {
                body.classList.remove('light-mode');
                localStorage.setItem('theme', 'dark-mode');
                themeToggle.textContent = '💡';
            } else {
                body.classList.add('light-mode');
                localStorage.setItem('theme', 'light-mode');
                themeToggle.textContent = '🌙';
            }
        });

        // === GET STORY ID FROM URL ===
        const urlParams = new URLSearchParams(window.location.search);
        const storyId = urlParams.get('storyId');

        // === ELEMENTS ===
        const storyPageTitle = document.getElementById('storyPageTitle');
        const storyTitleElem = document.getElementById('storyTitle');
        const storyAuthorElem = document.getElementById('storyAuthor');
        const storyGenreElem = document.getElementById('storyGenre');
        const storyThumbnailElem = document.getElementById('storyThumbnail');
        const storyContentElem = document.getElementById('storyContent');
        const storyViewsElem = document.getElementById('storyViews');
        const storyRatingElem = document.getElementById('storyRating');
        const storyRatingCountElem = document.getElementById('storyRatingCount');
        const ratingStarsContainer = document.getElementById('ratingStars');
        const ratingMessage = document.getElementById('ratingMessage');
        const commentForm = document.getElementById('commentForm');
        const commentContentInput = document.getElementById('commentContent');
        const commentListElem = document.getElementById('commentList');

        let currentUser = null; // Akan menyimpan user yang sedang login (jika ada)

        // --- AUTH STATE LISTENER ---
        // Ini penting untuk mengetahui apakah user sudah login saat memberikan rating/komentar
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                console.log("User is logged in:", user.uid);
                ratingMessage.textContent = "Click a star to rate!";
            } else {
                currentUser = null;
                console.log("No user is logged in.");
                ratingMessage.textContent = "Login to rate and comment.";
                // Disable rating and comment if not logged in
                ratingStarsContainer.style.pointerEvents = 'none';
                commentForm.style.pointerEvents = 'none';
                commentForm.querySelector('button').textContent = "Login to comment";
            }
        });


        // === LOAD STORY DETAILS, VIEWS, AND RATINGS ===
        document.addEventListener('DOMContentLoaded', async () => {
            if (!storyId) {
                storyTitleElem.textContent = 'Story Not Found';
                storyContentElem.innerHTML = '<p>No story ID provided in the URL.</p>';
                storyPageTitle.textContent = 'Error - AMDF Ebook';
                return;
            }

            try {
                // Fetch Story Details from Firestore
                const storyDoc = await db.collection('stories').doc(storyId).get();

                if (!storyDoc.exists) {
                    storyTitleElem.textContent = 'Story Not Found';
                    storyContentElem.innerHTML = '<p>The story you are looking for does not exist.</p>';
                    storyPageTitle.textContent = 'Not Found - AMDF Ebook';
                    return;
                }

                const storyData = storyDoc.data();
                storyPageTitle.textContent = storyData.title + ' - AMDF Ebook';
                storyTitleElem.textContent = storyData.title;
                storyAuthorElem.textContent = storyData.authorName;
                storyGenreElem.textContent = storyData.genre;
                storyThumbnailElem.src = storyData.thumbnailUrl || 'https://via.placeholder.com/800x450/cccccc/000000?text=No+Image';
                // Use innerHTML for rich text content, and replace \n with <br> for line breaks
                storyContentElem.innerHTML = storyData.content.replace(/\n/g, '<br>');


                // Increment Views in Realtime Database
                const viewsRef = rtdb.ref(`stories_stats/${storyId}/views`);
                viewsRef.transaction((currentViews) => {
                    return (currentViews || 0) + 1;
                }, (error, committed, snapshot) => {
                    if (error) {
                        console.error("Transaction failed: ", error);
                    } else if (committed) {
                        console.log("Views incremented!");
                        storyViewsElem.textContent = snapshot.val(); // Update displayed views
                    } else {
                        console.log("Views not incremented (transaction aborted).");
                    }
                });

                // Load Initial Views and Ratings (if transaction fails or for initial display)
                viewsRef.on('value', (snapshot) => {
                    storyViewsElem.textContent = snapshot.val() || 0;
                });

                const ratingsRef = rtdb.ref(`stories_stats/${storyId}/ratings`);
                ratingsRef.on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        let totalRating = 0;
                        let count = 0;
                        snapshot.forEach(childSnap => {
                            totalRating += childSnap.val();
                            count++;
                        });
                        storyRatingElem.textContent = (totalRating / count).toFixed(1);
                        storyRatingCountElem.textContent = count;
                    } else {
                        storyRatingElem.textContent = '0.0';
                        storyRatingCountElem.textContent = '0';
                    }
                });

                // Load Comments
                loadComments(storyId);

            } catch (error) {
                console.error("Error loading story details:", error);
                storyTitleElem.textContent = 'Error Loading Story';
                storyContentElem.innerHTML = '<p>An error occurred while loading the story. Please try again.</p>';
                storyPageTitle.textContent = 'Error - AMDF Ebook';
            }
        });

        // === RATING LOGIC ===
        ratingStarsContainer.addEventListener('mouseover', (e) => {
            if (e.target.classList.contains('star')) {
                const value = parseInt(e.target.dataset.value);
                Array.from(ratingStarsContainer.children).forEach(star => {
                    star.classList.toggle('filled', parseInt(star.dataset.value) <= value);
                });
            }
        });

        ratingStarsContainer.addEventListener('mouseout', () => {
            // Reset to current average rating or no fill if no rating given
            // For now, simply clear the hover effect if no current user rating is displayed
            updateStarDisplay(storyRatingElem.textContent.split('.')[0] || 0); // Re-fill based on current average or 0
        });

        ratingStarsContainer.addEventListener('click', async (e) => {
            if (e.target.classList.contains('star')) {
                if (!currentUser) {
                    alert('Please log in to submit a rating.');
                    return;
                }

                const ratingValue = parseInt(e.target.dataset.value);
                const userId = currentUser.uid; // Menggunakan UID Firebase Auth sebagai ID pengguna

                try {
                    // Save rating to Realtime Database
                    await rtdb.ref(`stories_stats/${storyId}/ratings/${userId}`).set(ratingValue);
                    alert(`Thanks for rating ${ratingValue} stars!`);
                    ratingMessage.textContent = `You rated: ${ratingValue} stars!`;
                    // The 'on value' listener for ratingsRef will automatically update the display
                } catch (error) {
                    console.error("Error submitting rating:", error);
                    alert("Failed to submit rating. Please try again.");
                }
            }
        });

        function updateStarDisplay(averageRating) {
            Array.from(ratingStarsContainer.children).forEach(star => {
                star.classList.toggle('filled', parseInt(star.dataset.value) <= Math.round(averageRating));
            });
        }


        // === COMMENT LOGIC ===
        commentForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUser) {
                alert('Please log in to post a comment.');
                return;
            }

            const commentContent = commentContentInput.value.trim();
            if (!commentContent) {
                alert('Comment cannot be empty.');
                return;
            }

            const username = currentUser.email ? currentUser.email.split('@')[0] : 'Anonymous User'; // Contoh nama pengguna
            // Anda mungkin ingin mengambil nama pengguna yang lebih ramah dari Firestore 'users' collection jika ada
            // Misalnya: const userDoc = await db.collection('users').doc(currentUser.uid).get();
            // const username = userDoc.exists ? userDoc.data().displayName : 'Anonymous User';


            try {
                // Save comment to Firestore
                await db.collection('comments').add({
                    storyId: storyId,
                    userId: currentUser.uid,
                    username: username,
                    content: commentContent,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() // Firestore Timestamp
                });

                alert('Comment posted successfully!');
                commentContentInput.value = ''; // Clear input
                loadComments(storyId); // Reload comments to show new one

            } catch (error) {
                console.error("Error posting comment:", error);
                alert("Failed to post comment. Please try again.");
            }
        });

        async function loadComments(storyId) {
            commentListElem.innerHTML = '<p>Loading comments...</p>'; // Show loading message

            try {
                const commentsSnapshot = await db.collection('comments')
                                                .where('storyId', '==', storyId)
                                                .orderBy('timestamp', 'desc')
                                                .get();

                if (commentsSnapshot.empty) {
                    commentListElem.innerHTML = '<p>No comments yet. Be the first to comment!</p>';
                    return;
                }

                commentListElem.innerHTML = ''; // Clear loading message
                commentsSnapshot.forEach(doc => {
                    const comment = doc.data();
                    const timestamp = comment.timestamp ? comment.timestamp.toDate().toLocaleString() : 'N/A'; // Format timestamp

                    const commentItem = document.createElement('div');
                    commentItem.className = 'comment-item';
                    commentItem.innerHTML = `
                        <strong>${comment.username || 'Anonymous'}</strong>
                        <p>${comment.content}</p>
                        <small>${timestamp}</small>
                    `;
                    commentListElem.appendChild(commentItem);
                });

            } catch (error) {
                console.error("Error loading comments:", error);
                commentListElem.innerHTML = '<p>Failed to load comments.</p>';
            }
        }
    </script>
</body>
</html>
